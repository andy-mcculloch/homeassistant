## WiFi Switches

  - platform: mqtt
    name: WiFiSwitch2_current
    state_topic: WiFiSwitch2/current
    unit_of_measurement: A
 
  - platform: mqtt
    name: WiFiSwitch2_voltage
    state_topic: WiFiSwitch2/voltage
    unit_of_measurement: V
 
  - platform: mqtt
    name: WiFiSwitch2_power
    state_topic: WiFiSwitch2/power
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch2_reactive
    state_topic: WiFiSwitch2/reactive
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch2_apparent
    state_topic: WiFiSwitch2/apparent
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch2_factor
    state_topic: WiFiSwitch2/factor
    unit_of_measurement: '%'
 
  - platform: mqtt
    name: WiFiSwitch2_energy
    state_topic: WiFiSwitch2/energy
    unit_of_measurement: J
 
  - platform: mqtt
    name: WiFiSwitch3_current
    state_topic: WiFiSwitch3/current
    unit_of_measurement: A
 
  - platform: mqtt
    name: WiFiSwitch3_voltage
    state_topic: WiFiSwitch3/voltage
    unit_of_measurement: V
 
  - platform: mqtt
    name: WiFiSwitch3_power
    state_topic: WiFiSwitch3/power
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch3_reactive
    state_topic: WiFiSwitch3/reactive
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch3_apparent
    state_topic: WiFiSwitch3/apparent
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch3_factor
    state_topic: WiFiSwitch3/factor
    unit_of_measurement: '%'
 
  - platform: mqtt
    name: WiFiSwitch3_energy
    state_topic: WiFiSwitch3/energy
    unit_of_measurement: J

  - platform: mqtt
    name: WiFiSwitch4_current
    state_topic: WiFiSwitch4/current
    unit_of_measurement: A
 
  - platform: mqtt
    name: WiFiSwitch4_voltage
    state_topic: WiFiSwitch4/voltage
    unit_of_measurement: V
 
  - platform: mqtt
    name: WiFiSwitch4_power
    state_topic: WiFiSwitch4/power
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch4_reactive
    state_topic: WiFiSwitch4/reactive
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch4_apparent
    state_topic: WiFiSwitch4/apparent
    unit_of_measurement: W
 
  - platform: mqtt
    name: WiFiSwitch4_factor
    state_topic: WiFiSwitch4/factor
    unit_of_measurement: '%'
 
  - platform: mqtt
    name: WiFiSwitch4_energy
    state_topic: WiFiSwitch4/energy
    unit_of_measurement: J
     
## Carbon Intensitiy

  - platform: rest
    name: Carbon intensity
    resource_template: >-
      {% set regionid = 12 %}
      https://api.carbonintensity.org.uk/regional/regionid/{{ regionid }}
    value_template: "{{ value_json.data[0].data[0].intensity.index }}"
    json_attributes_path: "$.data[0].data[0]"
    json_attributes:
      - "intensity"
      - "generationmix"


## octopus go rest template ##

  - platform: rest
    name: Gas consumption
    resource_template: >-
      {% set mprn = '2059966800' %}
      {% set serial = 'G4P01815061600' %}
      {% set date = as_timestamp(now() - timedelta(days = 2))|timestamp_custom('%Y-%m-%d') %}
      https://api.octopus.energy/v1/gas-meter-points/{{ mprn }}/meters/{{ serial }}/consumption/?period_from={{ date + 'T00:00:00' }}&period_to={{ date + 'T23:59:59' }}
    headers:
      Authorization: !secret octopus_auth
    value_template: "{{ value_json.results|sum(attribute='consumption')|round(3) }}"
    unit_of_measurement: 'kWh'
    device_class: energy
    json_attributes:
      - "results"

  - platform: template
    sensors:
      gas_cost:
        friendly_name: Gas cost
        icon_template: mdi:cash-multiple
        value_template: >-
          {% set unit_price = 3.95 %}
          {% set standing_charge = 23.85 %}
          {% set calorific_value = 39.1 %}
          {% set usage = state_attr('sensor.gas_consumption', 'results') %}
          {% if usage is defined and usage|count == 48 %}
            {{ ((states('sensor.gas_consumption') | float * 1.02264 * calorific_value / 3.6) * unit_price / 100 + standing_charge / 100)|round(2) }}
          {% else %}
            Unknown
          {% endif %}
        device_class: energy
        unit_of_measurement: '£'

  - platform: rest
    name: Electricity consumption
    resource_template: >-
      {% set mpan = '1100006662930' %}
      {% set serial = '16P0145697' %}
      {% set date = as_timestamp(now() - timedelta(days = 2))|timestamp_custom('%Y-%m-%d') %}
      https://api.octopus.energy/v1/electricity-meter-points/{{ mpan }}/meters/{{ serial }}/consumption/?period_from={{ date + 'T00:00:00' }}&period_to={{ date + 'T23:59:59' }}
    headers:
      Authorization: !secret octopus_auth
    value_template: "{{ value_json.results|sum(attribute='consumption')|round(3) }}"
    unit_of_measurement: 'kWh'
    device_class: energy
    json_attributes:
      - "results"

  - platform: rest
    name: Electricity consumption off peak
    resource_template: >-
      {% set mpan = '1100006662930' %}
      {% set serial = '16P0145697' %}
      {% set date = as_timestamp(now() - timedelta(days = 2))|timestamp_custom('%Y-%m-%d') %}
      https://api.octopus.energy/v1/electricity-meter-points/{{ mpan }}/meters/{{ serial }}/consumption/?period_from={{ date + 'T00:30:00' }}&period_to={{ date + 'T04:29:59' }}
    headers:
      Authorization: !secret octopus_auth
    value_template: "{{ value_json.results|sum(attribute='consumption')|round(3) }}"
    unit_of_measurement: 'kWh'
    device_class: energy
    json_attributes:
      - "results"

  - platform: template
    sensors:
      electricity_cost:
        friendly_name: Electricity cost
        icon_template: mdi:cash-multiple
        value_template: >-
          {% set standing_charge = 25 %}
          {% set usage = state_attr('sensor.electricity_consumption', 'results') %}
          {% if usage is defined and usage|count == 48 %}
            {% set ns = namespace(total=0) %}
            {% for p in range(0, 48) %}
              {% set time = as_timestamp(usage[p].interval_start)|timestamp_custom('%H:%M:%S') %}
              {% set unit_price = 15.59 %}
              {% if '00:30:00' <= time < '04:30:00' %}
                {% set unit_price = 5 %}
              {% endif %}
              {% set ns.total = ns.total + (usage[p].consumption * unit_price / 100) %}
            {% endfor %}
            {{ (ns.total + standing_charge / 100)|round(2) }}
          {% else %}
            Unknown
          {% endif %}
        unit_of_measurement: '£'
        device_class: monetary

  - platform: template
    sensors:
      electricity_cost_off_peak:
        friendly_name: Electricity cost off peak
        icon_template: mdi:cash-multiple
        value_template: >-
          {% set standing_charge = 0 %}
          {% set usage = state_attr('sensor.electricity_consumption_off_peak', 'results') %}
          {% if usage is defined and usage|count == 8 %}
            {% set ns = namespace(total=0) %}
            {% for p in range(0, 8) %}
              {% set time = as_timestamp(usage[p].interval_start)|timestamp_custom('%H:%M:%S') %}
              {% set unit_price = 5 %}
              {% set ns.total = ns.total + (usage[p].consumption * unit_price / 100) %}
            {% endfor %}
            {{ (ns.total + standing_charge / 100)|round(2) }}
          {% else %}
            Unknown
          {% endif %}
        unit_of_measurement: '£'
        device_class: monetary

  - platform: template
    sensors:
      total_energy_cost:
        friendly_name: "Energy Cost - Total"
        value_template: "{{ states('sensor.electricity_cost') | float + states('sensor.electricity_cost_off_peak') | float + states('sensor.gas_cost') | float}}"
        unit_of_measurement: '£'
        device_class: monetary

  - platform: template
    sensors:
      total_energy_consumption:
        friendly_name: "Energy Consumption - Total"
        value_template: "{{ states('sensor.electricity_consumption') | float + states('sensor.electricity_consumption_off_peak') | float + states('sensor.gas_consumption') | float}}"
        unit_of_measurement: 'kWh'
        device_class: energy
